# Empathy Synthesizer Agent - Workflow Diagram

```mermaid
graph TD
    %% Input Nodes
    A[📥 Data Ingestion] --> B[📋 Document Processing]
    B --> C[🔒 Consent Validation]
    C --> D[🛡️ PII Redaction]
    
    %% Core Processing Nodes
    D --> E[📊 Sentiment Analysis]
    D --> F[🏷️ Topic Modeling]
    D --> G[💬 Quote Extraction]
    
    %% Analysis Nodes
    E --> H[🧠 Insight Synthesis]
    F --> H
    G --> H
    
    %% Empathy Map Generation
    H --> I[🗺️ Empathy Map Builder]
    I --> J[✅ HITL Approval Gate]
    
    %% Quality & Validation
    J --> K[🔍 Quality Validation]
    K --> L[📈 Bias & Fairness Check]
    
    %% Output & Storage
    L --> M[📄 Document Generation]
    L --> N[💾 Data Storage]
    
    %% Feedback Loops
    K --> O{Validation Pass?}
    O -->|No| P[🔄 Refinement Loop]
    P --> H
    O -->|Yes| M
    
    J --> Q{HITL Approved?}
    Q -->|No| R[📝 Revision Request]
    R --> I
    Q -->|Yes| K
    
    %% Error Handling
    C --> S{Consent Valid?}
    S -->|No| T[❌ Consent Violation]
    T --> U[🚫 Stop Processing]
    S -->|Yes| D
    
    %% Metrics & Monitoring
    M --> V[📊 Metrics Collection]
    N --> V
    V --> W[📈 KPI Reporting]
    
    %% Styling with light gray background
    classDef inputNode fill:#e3f2fd,stroke:#1976d2,stroke-width:2px,color:#000
    classDef processNode fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px,color:#000
    classDef analysisNode fill:#e8f5e8,stroke:#388e3c,stroke-width:2px,color:#000
    classDef outputNode fill:#fff3e0,stroke:#f57c00,stroke-width:2px,color:#000
    classDef decisionNode fill:#ffebee,stroke:#d32f2f,stroke-width:2px,color:#000
    classDef errorNode fill:#ffcdd2,stroke:#c62828,stroke-width:2px,color:#000
    
    class A,B inputNode
    class C,D,E,F,G processNode
    class H,I analysisNode
    class M,N,V,W outputNode
    class O,Q,S decisionNode
    class T,U errorNode
```

## Node Descriptions

### **Input & Processing Nodes**
- **📥 Data Ingestion**: Receives support tickets
- **📋 Document Processing**: Normalizes and structures incoming support ticket data
- **🔒 Consent Validation**: Checks user consent for data processing
- **🛡️ PII Redaction**: Removes personally identifiable information

### **Analysis Nodes**
- **📊 Sentiment Analysis**: Analyzes emotional tone and sentiment
- **🏷️ Topic Modeling**: Identifies key themes and topics
- **💬 Quote Extraction**: Extracts relevant user quotes
- **🧠 Insight Synthesis**: Combines analysis results into insights

### **Empathy Map Generation**
- **🗺️ Empathy Map Builder**: Creates Say/Think/Do/Feel quadrants
- **✅ HITL Approval Gate**: Human review and approval
- **🔍 Quality Validation**: Validates empathy map quality
- **📈 Bias & Fairness Check**: Ensures unbiased analysis

### **Output & Storage**
- **📄 Document Generation**: Creates empathy maps and reports
- **💾 Data Storage**: Stores results in PostgreSQL
- **📊 Metrics Collection**: Tracks KPIs and performance
- **📈 KPI Reporting**: Generates performance reports

### **Decision Points**
- **Validation Pass?**: Checks if quality standards are met
- **HITL Approved?**: Confirms human approval
- **Consent Valid?**: Validates user consent

### **Error Handling**
- **❌ Consent Violation**: Handles consent violations
- **🚫 Stop Processing**: Halts processing on violations
- **🔄 Refinement Loop**: Iterative improvement process

## Data Flow

```mermaid
flowchart LR
    subgraph "Input Data"
        A1[Support Tickets]
    end
    
    subgraph "Processing Pipeline"
        B1[Consent Records]
        B2[Redacted Tickets]
        B3[Sentiment Scores]
        B4[Topic Clusters]
        B5[Extracted Quotes]
    end
    
    subgraph "Empathy Map"
        C1[Say Quadrant]
        C2[Think Quadrant]
        C3[Do Quadrant]
        C4[Feel Quadrant]
        C5[Goals & Pains]
        C6[Latent Needs]
    end
    
    subgraph "Output"
        D1[Empathy Maps]
        D2[Insight Reports]
        D3[Consent Reports]
        D4[PII Reports]
    end
    
    A1 --> B1
    
    B1 --> B2
    B2 --> B3
    B2 --> B4
    B2 --> B5
    
    B3 --> C1
    B4 --> C2
    B5 --> C3
    B3 --> C4
    B4 --> C5
    B5 --> C6
    
    C1 --> D1
    C2 --> D1
    C3 --> D1
    C4 --> D1
    C5 --> D2
    C6 --> D2
    B1 --> D3
    B2 --> D4
    
    %% Styling with consistent colors
    classDef inputData fill:#e3f2fd,stroke:#1976d2,stroke-width:2px,color:#000
    classDef processing fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px,color:#000
    classDef empathyMap fill:#e8f5e8,stroke:#388e3c,stroke-width:2px,color:#000
    classDef output fill:#fff3e0,stroke:#f57c00,stroke-width:2px,color:#000
    
    class A1 inputData
    class B1,B2,B3,B4,B5 processing
    class C1,C2,C3,C4,C5,C6 empathyMap
    class D1,D2,D3,D4 output
```

## State Transitions

```mermaid
stateDiagram-v2
    [*] --> DataIngestion
    DataIngestion --> ConsentValidation
    ConsentValidation --> PIIRedaction
    PIIRedaction --> Analysis
    Analysis --> EmpathyMapGeneration
    EmpathyMapGeneration --> HITLApproval
    HITLApproval --> QualityValidation
    QualityValidation --> BiasCheck
    BiasCheck --> DocumentGeneration
    DocumentGeneration --> [*]
    
    ConsentValidation --> ConsentViolation
    ConsentViolation --> [*]
    
    HITLApproval --> RevisionRequest
    RevisionRequest --> EmpathyMapGeneration
    
    QualityValidation --> RefinementLoop
    RefinementLoop --> Analysis
    
    %% Styling with consistent colors
    classDef inputState fill:#e3f2fd,stroke:#1976d2,stroke-width:2px,color:#000
    classDef processState fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px,color:#000
    classDef analysisState fill:#e8f5e8,stroke:#388e3c,stroke-width:2px,color:#000
    classDef outputState fill:#fff3e0,stroke:#f57c00,stroke-width:2px,color:#000
    classDef errorState fill:#ffcdd2,stroke:#c62828,stroke-width:2px,color:#000
    
    class DataIngestion,ConsentValidation,PIIRedaction inputState
    class Analysis,EmpathyMapGeneration,HITLApproval,QualityValidation,RevisionRequest,RefinementLoop processState
    class BiasCheck analysisState
    class DocumentGeneration outputState
    class ConsentViolation errorState
```

## Key Interactions

1. **Consent-First Processing**: All data must pass consent validation before processing
2. **PII Protection**: Automatic redaction before any analysis
3. **Multi-Modal Analysis**: Sentiment, topic, and quote analysis run in parallel
4. **Human Oversight**: HITL gates ensure quality and compliance
5. **Iterative Refinement**: Quality checks can trigger refinement loops
6. **Comprehensive Output**: Multiple report types for different stakeholders
